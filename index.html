<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>íƒ€ì´ë¨¸</title>
<style>
  :root {
    --primary: #B0B0B0;
    --accent: #EDF3EC;
    --text-dark: #222f3e;
    --text-light: #797d8c;
    --shadow: 0 2px 8px 0 rgba(0,0,0,0.1);
  }
  body {
    background: transparent;
    min-height: 100vh;
    margin: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: "Pretendard", "Apple SD Gothic Neo", Arial, sans-serif;
    padding: 20px;
    box-sizing: border-box;
  }
  .timer-container {
    background: #fff;
    padding: 16px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    display: inline-block;
    min-width: 280px;
    max-width: 400px;
    width: 100%;
    border: 1px solid var(--primary);
    text-align: center;
    position: relative;
    box-sizing: border-box;
  }
  
  /* ìƒë‹¨ ë²„íŠ¼ë“¤ */
  .top-controls {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 6px;
  }
  
  .top-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    color: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .top-btn:hover {
    transform: scale(1.1);
    background: var(--primary);
    color: #fff;
  }
  
  /* ì„¤ì • íŒ¨ë„ */
  .settings-panel {
    display: none;
    width: 100%;
    padding-top: 8px;
    max-height: 400px;
    overflow-y: auto;
  }
  .settings-panel.active {
    display: block;
  }

  /* íƒ€ì´ë¨¸ ì»¨í…ì¸  */
  .timer-content {
    display: block;
  }
  .timer-content.hidden {
    display: none;
  }

  .timer-content .top-controls {
    position: absolute;
    top: 8px;
    right: 8px;
  }

  .settings-panel .top-controls {
    position: absolute;
    top: 8px;
    left: 8px;
  }
  .settings-section {
    margin-bottom: 12px;
  }
  .settings-section:last-child {
    margin-bottom: 0;
  }
  .settings-section h4 {
    margin: 0 0 6px 0;
    color: var(--text-dark);
    font-size: 12px;
  }
  
  /* ëª¨ë“œ ì„ íƒ */
  .mode-options {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
  }
  .mode-option {
    padding: 4px 8px;
    border: 1px solid var(--primary);
    background: transparent;
    color: var(--text-light);
    border-radius: 6px;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.2s;
  }
  .mode-option.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  
  /* ìƒ‰ìƒ ì„¤ì • */
  .color-section {
    margin-bottom: 8px;
  }
  .color-section:last-child {
    margin-bottom: 0;
  }
  .color-section label {
    display: block;
    font-size: 11px;
    color: var(--text-light);
    margin-bottom: 4px;
  }
  .color-row {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-bottom: 4px;
  }
  .color-option {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #fff;
    cursor: pointer;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .color-option:hover {
    transform: scale(1.1);
  }
  .color-option.active {
    border: 2px solid var(--text-dark);
    transform: scale(1.1);
  }
  .color-picker {
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
  }
  .color-picker::-webkit-color-swatch-wrapper {
    padding: 0;
    border-radius: 50%;
  }
  .color-picker::-webkit-color-swatch {
    border: 2px solid #fff;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  /* ì…ë ¥ ì„¹ì…˜ */
  .inputs {
    margin-bottom: 2px;
    min-height: 44px; /* ê³ ì • ë†’ì´ë¡œ ëª¨ë“  ëª¨ë“œì—ì„œ ë™ì¼í•œ í¬ê¸° ìœ ì§€ */
  }
  .inputs.hidden {
    display: none;
  }
  #pomodoroInputs, #timerInputs {
    display: block;
  }
  #pomodoroInputs.hidden, #timerInputs.hidden {
    display: none;
  }
  
  /* ë½€ëª¨ë„ë¡œ ì…ë ¥ ë ˆì´ì•„ì›ƒ - ë°˜ì‘í˜• */
  .pomodoro-inputs-wrapper {
    display: flex;
    flex-wrap: nowrap;
    gap: 4px;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    color: var(--text-light);
  }
  
  label {
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 3px;
  }
  input[type="number"] {
    padding: 2px;
    width: 30px;
    height: 18px;
    font-size: 11px;
    border: 1px solid var(--primary);
    border-radius: 3px;
    text-align: center;
    outline: none;
    color: var(--primary);
    background: #fff;
    -moz-appearance: textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"]:focus {
    border-color: var(--accent);
  }
  
  /* íƒ€ì´ë¨¸ í‘œì‹œ */
  #timer {
    font-size: clamp(32px, 7vw, 48px);
    color: var(--primary);
    margin: 0px 0 8px 0;
    font-weight: 700;
    letter-spacing: 2px;
  }
  
  /* ë²„íŠ¼ ê·¸ë£¹ */
  .btn-group {
    margin-top: 12px;
    display: flex; justify-content: center; gap: 8px;
  }
  button.control-btn {
    font-size: 12px;
    padding: 6px 10px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 6px;
    margin: 0;
    cursor: pointer;
    transition: all .2s;
    min-width: 50px;
    font-weight: 500;
  }
  button.control-btn:hover:not(:disabled) {
    background: var(--accent);
    transform: translateY(-1px);
  }
  button.control-btn:disabled {
    background: var(--primary);
    color: #fff;
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  button.control-btn:disabled:hover {
    background: var(--primary);
    opacity: 0.5;
  }
  #pauseBtn.paused {
    background: var(--accent);
  }
  #pauseBtn.paused:hover:not(:disabled) {
    background: var(--primary);
  }
  
  /* í”Œë˜ì‹œ íš¨ê³¼ */
  .flash {
    animation: flash 0.4s linear 0s 3;
  }
  @keyframes flash {
    0%   { background: #fff; }
    30%  { background: var(--accent); }
    50%  { background: var(--primary); }
    80%  { background: var(--accent); }
    100% { background: #fff; }
  }
 /*  - ëŒ€ê¸° ìƒíƒœ ìŠ¤íƒ€ì¼ë§ê³¼ ì‚¬ì´í´ í‘œì‹œ */
    .waiting-state {
        position: relative;
        animation: waitingPulse 2s infinite;
    }

    @keyframes waitingPulse {
        0%, 100% { 
        background: #fff;
        transform: scale(1);
        }
        50% { 
        background: var(--accent);
        transform: scale(1.02);
        }
    }

    .cycle-info {
        position: absolute;
        top: 50px;
        left: 16px;
        right: 16px;
        font-size: 11px;
        color: var(--text-light);
        line-height: 1.2;
        display: none;
        text-align: center;
        z-index: 1;
        }

    .cycle-info.show {
        display: block;
    }

    .sound-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .sound-toggle label {
        font-size: 11px;
        color: var(--text-light);
    }

    .toggle-switch {
        position: relative;
        width: 40px;
        height: 20px;
        background: #ddd;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle-switch.active {
        background: var(--primary);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transition: left 0.3s;
    }

    .toggle-switch.active::after {
        left: 22px;
    }

  /* ë°˜ì‘í˜• ë””ìì¸ */
  @media (max-width: 480px) {
    body {
      padding: 10px;
    }
    .timer-container {
      min-width: 250px;
      padding: 12px;
    }
    #timer {
      font-size: clamp(28px, 8vw, 40px);
      margin: 0px 0 6px 0;
    }
    .btn-group {
      gap: 6px;
      margin-top: 10px;
    }
    button.control-btn {
      font-size: 11px;
      padding: 5px 8px;
      min-width: 45px;
    }
    .cycle-info {
        top: 45px;
        left: 12px;
        right: 12px;
        font-size: 10px;
    }
    .settings-panel {
      min-width: 160px;
      padding: 12px;
    }
    .inputs {
      margin-bottom: 0px;
    }
    
    /* ë½€ëª¨ë„ë¡œ ì…ë ¥ì„ í•œ ì¤„ë¡œ ìœ ì§€ */
    .pomodoro-inputs-wrapper {
      flex-direction: row;
      justify-content: center;
      gap: 3px;
      width: 100%;
      font-size: 11px;
    }
    
    .timer-container {
      padding-top: 20px; /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
    }
  }

  @media (max-width: 320px) {
    .timer-container {
      min-width: 220px;
      padding: 10px;
      padding-top: 24px;
    }
    label {
      font-size: 10px;
    }
    input[type="number"] {
      width: 28px;
      height: 16px;
      font-size: 10px;
    }
    .pomodoro-inputs-wrapper {
      flex-direction: row;
      justify-content: center;
      gap: 2px;
      width: 100%;
      font-size: 10px;
    }
  }
</style>
</head>
<body>
<div class="timer-container" id="mainContainer">
  <!-- íƒ€ì´ë¨¸ í™”ë©´ -->
  <div class="timer-content" id="timerContent">
    <div class="cycle-info" id="cycleInfo"></div>

    <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
    <div class="top-controls">
      <button class="top-btn" id="settingsBtn" title="ì„¤ì •">âš™ï¸</button>
    </div>

    <div class="inputs" id="inputSection">
      <div id="pomodoroInputs">
        <div class="pomodoro-inputs-wrapper">
          <input type="number" id="workInput" value="25" min="1" max="180">ë¶„ /
          <input type="number" id="breakInput" value="5" min="1" max="60">ë¶„ /
          <input type="number" id="cyclesInput" value="4" min="1" max="20">íšŒ
        </div>
      </div>
      <div id="timerInputs" class="hidden">
        <div style="display: flex; justify-content: center; align-items: center;">
          <label>
            <input type="number" id="timerMinutes" value="10" min="1" max="999">ë¶„
          </label>
        </div>
      </div>
    </div>

    <div id="timer">25:00</div>

    <div class="btn-group">
      <button class="control-btn" id="startBtn">START</button>
      <button class="control-btn" id="pauseBtn" disabled>PAUSE</button>
      <button class="control-btn" id="stopBtn" disabled>RESET</button>
    </div>
  </div>

  <!-- ì„¤ì • íŒ¨ë„ -->
  <div class="settings-panel" id="settingsPanel">
    <div class="top-controls">
      <button class="top-btn" id="backBtn" title="ë’¤ë¡œê°€ê¸°">â†</button>
    </div>

    <h3 style="margin: 0 0 16px 0; text-align: center; color: var(--text-dark); font-size: 18px;">ì„¤ì •</h3>

    <div class="settings-section">
      <h4>ëª¨ë“œ ì„ íƒ</h4>
      <div class="mode-options">
        <button class="mode-option active" data-mode="0">ë½€ëª¨ë„ë¡œ</button>
        <button class="mode-option" data-mode="1">íƒ€ì´ë¨¸</button>
        <button class="mode-option" data-mode="2">ìŠ¤í†±ì›Œì¹˜</button>
      </div>
    </div>

    <div class="settings-section">
        <h4>ì‚¬ìš´ë“œ ì„¤ì •</h4>
        <div class="sound-toggle">
          <label>ì•Œë¦¼ìŒ</label>
          <div class="toggle-switch active" id="soundToggle"></div>
        </div>
      </div>
      
    <div class="settings-section">
      <h4>í…Œë§ˆ ìƒ‰ìƒ</h4>
      
      <div class="color-section">
        <label>ë©”ì¸ ìƒ‰ìƒ</label>
        <div class="color-row">
          <div class="color-option active" data-color="#6b8eef" data-type="primary" style="background: #6b8eef;"></div>
          <div class="color-option" data-color="#ff6b6b" data-type="primary" style="background: #ff6b6b;"></div>
          <div class="color-option" data-color="#4ecdc4" data-type="primary" style="background: #4ecdc4;"></div>
          <div class="color-option" data-color="#96ceb4" data-type="primary" style="background: #96ceb4;"></div>
          <div class="color-option" data-color="#9b59b6" data-type="primary" style="background: #9b59b6;"></div>
          <div class="color-option" data-color="#f39c12" data-type="primary" style="background: #f39c12;"></div>
          <input type="color" class="color-picker" id="primaryPicker" value="#B0B0B0">
        </div>
      </div>
      
      <div class="color-section">
        <label>ê°•ì¡° ìƒ‰ìƒ</label>
        <div class="color-row">
          <div class="color-option active" data-color="#f99ca9" data-type="accent" style="background: #f99ca9;"></div>
          <div class="color-option" data-color="#4ecdc4" data-type="accent" style="background: #4ecdc4;"></div>
          <div class="color-option" data-color="#45b7d1" data-type="accent" style="background: #45b7d1;"></div>
          <div class="color-option" data-color="#feca57" data-type="accent" style="background: #feca57;"></div>
          <div class="color-option" data-color="#e74c3c" data-type="accent" style="background: #e74c3c;"></div>
          <div class="color-option" data-color="#95a5a6" data-type="accent" style="background: #95a5a6;"></div>
          <input type="color" class="color-picker" id="accentPicker" value="#EDF3EC">
        </div>
      </div>
    </div>
  </div>

</div>
<audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
<script>
  let workMinutes, breakMinutes, cycles;
  let currentCycle = 0;
  let isWork = true;
  let timer, totalSeconds, running = false, paused = false;
  
// ëª¨ë“œ ê´€ë¦¬
  let currentMode = 0; // 0: ë½€ëª¨ë„ë¡œ, 1: íƒ€ì´ë¨¸, 2: ìŠ¤í†±ì›Œì¹˜
  let soundEnabled = true;
  let waitingForUser = false;

  // ìƒ‰ìƒ ìºì‹± (getComputedStyle ìµœì í™”)
  let cachedPrimaryColor = '#B0B0B0';
  let cachedAccentColor = '#EDF3EC';   

  const statusEl = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const alarmSound = document.getElementById('alarmSound');
  const mainContainer = document.getElementById('mainContainer');

  const workInput = document.getElementById('workInput');
  const breakInput = document.getElementById('breakInput');
  const cyclesInput = document.getElementById('cyclesInput');
  const inputSection = document.getElementById('inputSection');

  // ì„¤ì • ê´€ë ¨
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const timerContent = document.getElementById('timerContent');
  const backBtn = document.getElementById('backBtn');
  const primaryPicker = document.getElementById('primaryPicker');
  const accentPicker = document.getElementById('accentPicker');
  const modeOptions = document.querySelectorAll('.mode-option');

  // ì´ˆê¸° í…Œë§ˆ ì„¤ì •
  function updateTheme(primary, accent) {
    document.documentElement.style.setProperty('--primary', primary);
    document.documentElement.style.setProperty('--accent', accent);
  }

// ê° ëª¨ë“œë³„ ìƒíƒœ ì €ì¥
  let modeStates = {
    0: { running: false, paused: false, timer: null, totalSeconds: 0, currentCycle: 0, isWork: true }, // ë½€ëª¨ë„ë¡œ
    1: { running: false, paused: false, timer: null, totalSeconds: 0 }, // íƒ€ì´ë¨¸
    2: { running: false, paused: false, timer: null, totalSeconds: 0 }  // ìŠ¤í†±ì›Œì¹˜
  };

  // ì„¤ì • ì €ì¥
  function saveSettings() {
    const settings = {
      currentMode,
      soundEnabled,
      // ìµœì í™”: ìºì‹œëœ ìƒ‰ìƒ ì‚¬ìš©
      primaryColor: cachedPrimaryColor,
      accentColor: cachedAccentColor,
      workMinutes: workInput.value,
      breakMinutes: breakInput.value,
      cycles: cyclesInput.value,
      timerMinutes: document.getElementById('timerMinutes').value
    };
    localStorage.setItem('timerSettings', JSON.stringify(settings));
  }

  // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  function loadSettings() {
    const saved = localStorage.getItem('timerSettings');
    if (saved) {
      const settings = JSON.parse(saved);
      currentMode = settings.currentMode || 0;
      soundEnabled = settings.soundEnabled !== false;

      if (settings.primaryColor) {
        cachedPrimaryColor = settings.primaryColor;
        document.documentElement.style.setProperty('--primary', settings.primaryColor);
        primaryPicker.value = settings.primaryColor;
      }
      if (settings.accentColor) {
        cachedAccentColor = settings.accentColor;
        document.documentElement.style.setProperty('--accent', settings.accentColor);
        accentPicker.value = settings.accentColor;
      }

      workInput.value = settings.workMinutes || 25;
      breakInput.value = settings.breakMinutes || 5;
      cyclesInput.value = settings.cycles || 4;
      document.getElementById('timerMinutes').value = settings.timerMinutes || 10;

      // UI ì—…ë°ì´íŠ¸
      modeOptions.forEach((opt, index) => {
        opt.classList.toggle('active', index === currentMode);
      });

      document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
    }
  }

  // ëª¨ë“œ ë³€ê²½
  modeOptions.forEach(option => {
    option.addEventListener('click', () => {
      // í˜„ì¬ ëª¨ë“œ ìƒíƒœ ì €ì¥
      saveCurrentModeState();
      
      modeOptions.forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      currentMode = parseInt(option.dataset.mode);
      
      // ìƒˆ ëª¨ë“œ ìƒíƒœ ë³µì›
      restoreModeState();
      updateMode();
    });
  });

  // í˜„ì¬ ëª¨ë“œ ìƒíƒœ ì €ì¥
  function saveCurrentModeState() {
    // í˜„ì¬ í‘œì‹œëœ ìƒíƒœëŠ” ì €ì¥í•˜ì§€ ì•Šê³ , ê° ëª¨ë“œë³„ ë…ë¦½ ìƒíƒœë§Œ ìœ ì§€
  }

  // ëª¨ë“œ ìƒíƒœ ë³µì›
  function restoreModeState() {
    const state = modeStates[currentMode];
    
    // UI ìƒíƒœ ì—…ë°ì´íŠ¸
    updateButtonStates(state);
    if (state.running) {
      updateTimerDisplay(state);
    }
  }

  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateButtonStates(state) {
    startBtn.disabled = state.running;
    pauseBtn.disabled = !state.running;
    stopBtn.disabled = !state.running;
    
    if (state.running && state.paused) {
      pauseBtn.textContent = 'RESUME';
      pauseBtn.classList.add('paused');
    } else {
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
  }

  // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateTimerDisplay(state) {
    const minutes = Math.floor(state.totalSeconds / 60);
    const seconds = state.totalSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  function updateMode() {
    const pomodoroInputs = document.getElementById('pomodoroInputs');
    const timerInputs = document.getElementById('timerInputs');
    const cycleInfo = document.getElementById('cycleInfo');
    
    // ëª¨ë“  ì…ë ¥ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    pomodoroInputs.classList.add('hidden');
    timerInputs.classList.add('hidden');
    cycleInfo.classList.remove('show'); // ì‚¬ì´í´ ì •ë³´ ìˆ¨ê¸°ê¸°
    
    switch(currentMode) {
      case 0: // ë½€ëª¨ë„ë¡œ
        pomodoroInputs.classList.remove('hidden');
        cycleInfo.classList.add('show'); // ë½€ëª¨ë„ë¡œì—ì„œë§Œ ì‚¬ì´í´ ì •ë³´ í‘œì‹œ
        const state0 = modeStates[0];
        if (!state0.running) {
          timerEl.textContent = `${workInput.value.toString().padStart(2,'0')}:00`;
          cycleInfo.textContent = ''; // ì´ˆê¸° ìƒíƒœì—ì„œëŠ” ë¹ˆ í…ìŠ¤íŠ¸
        } else {
          updateTimerDisplay(state0);
        }
        break;
      case 1: // íƒ€ì´ë¨¸
        timerInputs.classList.remove('hidden');
        const state1 = modeStates[1];
        if (!state1.running) {
          const timerMinutes = parseInt(document.getElementById('timerMinutes').value, 10) || 10;
          timerEl.textContent = `${timerMinutes.toString().padStart(2,'0')}:00`;
        } else {
          updateTimerDisplay(state1);
        }
        break;
      case 2: // ìŠ¤í†±ì›Œì¹˜
        // ìŠ¤í†±ì›Œì¹˜ëŠ” ì…ë ¥ ì˜ì—­ì´ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ê³µê°„ìœ¼ë¡œ ë™ì¼í•œ ë†’ì´ ìœ ì§€
        inputSection.style.minHeight = '44px';
        const state2 = modeStates[2];
        if (!state2.running) {
          timerEl.textContent = '00:00';
        } else {
          updateTimerDisplay(state2);
        }
        break;
    }
  }

  // ì„¤ì • í™”ë©´ ì „í™˜
  settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    timerContent.classList.add('hidden');
    settingsPanel.classList.add('active');
  });

  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
  backBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    settingsPanel.classList.remove('active');
    timerContent.classList.remove('hidden');
  });

  // ìƒ‰ìƒ ì˜µì…˜ ì„ íƒ
  const colorOptions = document.querySelectorAll('.color-option');
  colorOptions.forEach(option => {
    option.addEventListener('click', () => {
      const color = option.dataset.color;
      const type = option.dataset.type;

      // ìµœì í™”: í™œì„±í™”ëœ ê²ƒë§Œ ì°¾ì•„ì„œ ì œê±°
      document.querySelector(`[data-type="${type}"].active`)?.classList.remove('active');
      option.classList.add('active');

      document.documentElement.style.setProperty(`--${type}`, color);

      // ìƒ‰ìƒ ìºì‹œ ì—…ë°ì´íŠ¸
      if (type === 'primary') {
        cachedPrimaryColor = color;
        primaryPicker.value = color;
      } else {
        cachedAccentColor = color;
        accentPicker.value = color;
      }

      saveSettings();
    });
  });

  // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì„ íƒ
  primaryPicker.addEventListener('change', (e) => {
    const color = e.target.value;
    cachedPrimaryColor = color; // ìºì‹œ ì—…ë°ì´íŠ¸
    document.documentElement.style.setProperty('--primary', color);
    // ìµœì í™”: í™œì„±í™”ëœ ê²ƒë§Œ ì°¾ì•„ì„œ ì œê±°
    document.querySelector('[data-type="primary"].active')?.classList.remove('active');
    saveSettings();
  });

  accentPicker.addEventListener('change', (e) => {
    const color = e.target.value;
    cachedAccentColor = color; // ìºì‹œ ì—…ë°ì´íŠ¸
    document.documentElement.style.setProperty('--accent', color);
    // ìµœì í™”: í™œì„±í™”ëœ ê²ƒë§Œ ì°¾ì•„ì„œ ì œê±°
    document.querySelector('[data-type="accent"].active')?.classList.remove('active');
    saveSettings();
  });

  function updateTimer() {
    const state = modeStates[currentMode];
    const minutes = Math.floor(state.totalSeconds / 60);
    const seconds = state.totalSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  function flashScreen(times=3) {
    // ìµœì í™”: CSS animation ì‚¬ìš©
    mainContainer.classList.add('flash');
    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ í´ë˜ìŠ¤ ì œê±°
    setTimeout(() => mainContainer.classList.remove('flash'), times * 400);
  }

  function startPomodoro() {
    const state = modeStates[0];
    
    if (state.currentCycle >= state.cycles) {
      if (currentMode === 0) {
        timerEl.textContent = 'ğŸ‰ ì™„ë£Œ! ğŸ‰';
        document.getElementById('cycleInfo').textContent = `ëª¨ë“  ì‚¬ì´í´ ì™„ë£Œ!`;
      }
      state.running = false;
      if (currentMode === 0) {
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }
      return;
    }
    
    // ëŒ€ê¸° ìƒíƒœë¼ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì§€ ì•ŠìŒ
    if (waitingForUser) return;
    
    if (state.isWork) {
      state.totalSeconds = state.workMinutes * 60;
      if (currentMode === 0) {
        document.getElementById('cycleInfo').textContent = 
          `${state.currentCycle + 1}/${state.cycles} ì‚¬ì´í´ - ì§‘ì¤‘ì‹œê°„`;
      }
    } else {
      state.totalSeconds = state.breakMinutes * 60;
      if (currentMode === 0) {
        document.getElementById('cycleInfo').textContent = 
          `${state.currentCycle + 1}/${state.cycles} ì‚¬ì´í´ - íœ´ì‹ì‹œê°„`;
      }
    }
    
    if (currentMode === 0) updateTimer();
    
    state.running = true;
    state.paused = false;
    
    if (currentMode === 0) {
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
    
    state.timer = setInterval(() => {
      if (!state.paused) {
        state.totalSeconds--;
        if (currentMode === 0) updateTimer();
        
        if (state.totalSeconds <= 0) {
          clearInterval(state.timer);
          
          // ì•Œë¦¼ ì¬ìƒ
          if (soundEnabled) {
            alarmSound.currentTime = 0;
            alarmSound.play().catch(() => {}); // Promise rejection ì²˜ë¦¬
          }
          
          // ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜
          waitingForUser = true;
          if (currentMode === 0) {
            mainContainer.classList.add('waiting-state');
            timerEl.textContent = 'í´ë¦­í•˜ì—¬ ê³„ì†';
            document.getElementById('cycleInfo').textContent = 
              `${state.currentCycle + 1}/${state.cycles} ì‚¬ì´í´ - ${state.isWork ? 'ì§‘ì¤‘' : 'íœ´ì‹'} ì™„ë£Œ!`;
          }
          
          // ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤€ë¹„ (ì‹¤ì œ ì „í™˜ì€ ì‚¬ìš©ì í´ë¦­ í›„)
          if (!state.isWork) state.currentCycle++;
          state.isWork = !state.isWork;
          
          state.running = false;
          if (currentMode === 0) {
            startBtn.disabled = true;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
          }
        }
      }
    }, 1000);
  }

  function startRegularTimer() {
    const state = modeStates[1];
    const minutes = parseInt(document.getElementById('timerMinutes').value, 10);
    
    if (isNaN(minutes) || minutes <= 0) {
      alert('ì˜¬ë°”ë¥¸ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      if (currentMode === 1) {
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }
      return;
    }
    
    state.totalSeconds = minutes * 60;
    state.timerMinutes = minutes;
    
    if (currentMode === 1) updateTimer();
    
    state.running = true;
    state.paused = false;
    
    if (currentMode === 1) {
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
    
    state.timer = setInterval(() => {
      if (!state.paused) {
        state.totalSeconds--;
        if (currentMode === 1) updateTimer();
        
        if (state.totalSeconds <= 0) {
          clearInterval(state.timer);
          if (soundEnabled) {
            alarmSound.currentTime = 0;
            alarmSound.play().catch(() => {}); // Promise rejection ì²˜ë¦¬
          }
          if (currentMode === 1) {
            flashScreen(3);
            timerEl.textContent = 'â° ì™„ë£Œ!';
          }
          
          state.running = false;
          if (currentMode === 1) {
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
          }
        }
      }
    }, 1000);
  }

  function startStopwatch() {
    const state = modeStates[2];
    
    state.totalSeconds = 0;
    if (currentMode === 2) updateTimer();
    
    state.running = true;
    state.paused = false;
    
    if (currentMode === 2) {
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
    
    state.timer = setInterval(() => {
      if (!state.paused) {
        state.totalSeconds++;
        if (currentMode === 2) updateTimer();
      }
    }, 1000);
  }

  function stopTimer() {
    // ëŒ€ê¸° ìƒíƒœ ì´ˆê¸°í™”
    waitingForUser = false;
    mainContainer.classList.remove('waiting-state');
    
    const state = modeStates[currentMode];
    
    clearInterval(state.timer);
    
    // í˜„ì¬ ëª¨ë“œ ìƒíƒœ ì´ˆê¸°í™”
    state.running = false;
    state.paused = false;
    state.timer = null;
    state.totalSeconds = 0;
    
    alarmSound.pause();
    alarmSound.currentTime = 0;
    
    if (currentMode === 0) { // ë½€ëª¨ë„ë¡œ
      state.currentCycle = 0;
      state.isWork = true;
      timerEl.textContent = `${workInput.value.toString().padStart(2,'0')}:00`;
      document.getElementById('cycleInfo').textContent = ''; // ì‚¬ì´í´ ì •ë³´ ì´ˆê¸°í™”
    } else if (currentMode === 1) { // íƒ€ì´ë¨¸
      const timerMinutes = parseInt(document.getElementById('timerMinutes').value, 10) || 10;
      timerEl.textContent = `${timerMinutes.toString().padStart(2,'0')}:00`;
    } else if (currentMode === 2) { // ìŠ¤í†±ì›Œì¹˜
      timerEl.textContent = '00:00';
    }
    
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    pauseBtn.textContent = 'PAUSE';
    pauseBtn.classList.remove('paused');
    stopBtn.disabled = true;
  }

  function pauseTimer() {
    const state = modeStates[currentMode];
    
    if (state.running && !state.paused) {
      state.paused = true;
      pauseBtn.textContent = 'RESUME';
      pauseBtn.classList.add('paused');
    } else if (state.running && state.paused) {
      state.paused = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
  }

  startBtn.addEventListener('click', () => {
    const state = modeStates[currentMode];
    
    // í˜„ì¬ ëª¨ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
    state.running = true;
    state.paused = false;
    
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    stopBtn.disabled = false;
    
    switch(currentMode) {
      case 0: // ë½€ëª¨ë„ë¡œ
        const workMin = parseInt(workInput.value, 10);
        const breakMin = parseInt(breakInput.value, 10);
        const cycleCount = parseInt(cyclesInput.value, 10);
        
        if (isNaN(workMin) || workMin <= 0 || isNaN(breakMin) || breakMin <= 0 || isNaN(cycleCount) || cycleCount <= 0) {
          alert('ëª¨ë“  ì…ë ¥ê°’ì€ ì–‘ì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
          state.running = false;
          startBtn.disabled = false;
          pauseBtn.disabled = true;
          stopBtn.disabled = true;
          return;
        }
        
        state.workMinutes = workMin;
        state.breakMinutes = breakMin;
        state.cycles = cycleCount;
        state.currentCycle = 0;
        state.isWork = true;
        startPomodoro();
        break;
      case 1: // íƒ€ì´ë¨¸
        startRegularTimer();
        break;
      case 2: // ìŠ¤í†±ì›Œì¹˜
        startStopwatch();
        break;
    }
  });

  stopBtn.addEventListener('click', stopTimer);
  pauseBtn.addEventListener('click', pauseTimer);

  // ëŒ€ê¸° ìƒíƒœì—ì„œ í´ë¦­í•˜ë©´ ë‹¤ìŒ íƒ€ì´ë¨¸ ì‹œì‘
  timerContent.addEventListener('click', () => {
    if (waitingForUser && currentMode === 0) {
      waitingForUser = false;
      mainContainer.classList.remove('waiting-state');
      startPomodoro();
    }
  });

  // ì‚¬ìš´ë“œ í† ê¸€
  document.addEventListener('DOMContentLoaded', () => {
    const soundToggle = document.getElementById('soundToggle');
    if (soundToggle) {
      soundToggle.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        soundToggle.classList.toggle('active', soundEnabled);
        saveSettings();
      });
    }
  });

  // ì„¤ì • ì €ì¥ ì´ë²¤íŠ¸ë“¤
  [workInput, breakInput, cyclesInput].forEach(input => {
    input.addEventListener('change', saveSettings);
  });
  document.getElementById('timerMinutes').addEventListener('change', saveSettings);

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  window.addEventListener('load', () => {
    loadSettings();
    updateMode();
  });

  // ì´ˆê¸° ëª¨ë“œ ì„¤ì •
  updateMode();

</script>
</body>
</html>

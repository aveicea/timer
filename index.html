<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>타이머</title>
<style>
  :root {
    --primary: #6b8eef;
    --accent: #f99ca9;
    --text-dark: #222f3e;
    --text-light: #797d8c;
    --shadow: 0 2px 8px 0 rgba(0,0,0,0.1);
  }
  body {
    background: transparent;
    min-height: 100vh;
    margin: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: "Pretendard", "Apple SD Gothic Neo", Arial, sans-serif;
    padding: 20px;
    box-sizing: border-box;
  }
  .timer-container {
    background: #fff;
    padding: 16px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    display: inline-block;
    min-width: 280px;
    max-width: 400px;
    width: 100%;
    border: 1px solid var(--primary);
    text-align: center;
    position: relative;
    box-sizing: border-box;
  }
  
  /* 상단 버튼들 */
  .top-controls {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 6px;
  }
  
  .top-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    color: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .top-btn:hover {
    transform: scale(1.1);
    background: var(--primary);
    color: #fff;
  }
  
  /* 설정 패널 */
  .settings-panel {
    position: absolute;
    top: 40px;
    right: 8px;
    background: #fff;
    border: 1px solid var(--primary);
    border-radius: 12px;
    padding: 16px;
    box-shadow: var(--shadow);
    display: none;
    z-index: 10;
    min-width: 200px;
  }
  .settings-panel.active {
    display: block;
  }
  .settings-section {
    margin-bottom: 12px;
  }
  .settings-section:last-child {
    margin-bottom: 0;
  }
  .settings-section h4 {
    margin: 0 0 6px 0;
    color: var(--text-dark);
    font-size: 12px;
  }
  
  /* 모드 선택 */
  .mode-options {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
  }
  .mode-option {
    padding: 4px 8px;
    border: 1px solid var(--primary);
    background: transparent;
    color: var(--text-light);
    border-radius: 6px;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.2s;
  }
  .mode-option.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  
  /* 색상 설정 */
  .color-section {
    margin-bottom: 8px;
  }
  .color-section:last-child {
    margin-bottom: 0;
  }
  .color-section label {
    display: block;
    font-size: 11px;
    color: var(--text-light);
    margin-bottom: 4px;
  }
  .color-row {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-bottom: 4px;
  }
  .color-option {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #fff;
    cursor: pointer;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .color-option:hover {
    transform: scale(1.1);
  }
  .color-option.active {
    border: 2px solid var(--text-dark);
    transform: scale(1.1);
  }
  .color-picker {
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
  }
  .color-picker::-webkit-color-swatch-wrapper {
    padding: 0;
    border-radius: 50%;
  }
  .color-picker::-webkit-color-swatch {
    border: 2px solid #fff;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  /* 입력 섹션 */
  .inputs {
    margin-bottom: 2px;
    min-height: 44px; /* 고정 높이로 모든 모드에서 동일한 크기 유지 */
  }
  .inputs.hidden {
    display: none;
  }
  #pomodoroInputs, #timerInputs {
    display: block;
  }
  #pomodoroInputs.hidden, #timerInputs.hidden {
    display: none;
  }
  
  /* 뽀모도로 입력 레이아웃 - 반응형 */
  .pomodoro-inputs-wrapper {
    display: flex;
    flex-wrap: nowrap;
    gap: 4px;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    color: var(--text-light);
  }
  
  label {
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 3px;
  }
  input[type="number"] {
    padding: 2px;
    width: 30px;
    height: 18px;
    font-size: 11px;
    border: 1px solid var(--primary);
    border-radius: 3px;
    text-align: center;
    outline: none;
    color: var(--primary);
    background: #fff;
    -moz-appearance: textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"]:focus {
    border-color: var(--accent);
  }
  
  /* 타이머 표시 */
  #timer {
    font-size: clamp(32px, 7vw, 48px);
    color: var(--primary);
    margin: 0px 0 8px 0;
    font-weight: 700;
    letter-spacing: 2px;
  }
  
  /* 버튼 그룹 */
  .btn-group {
    margin-top: 12px;
    display: flex; justify-content: center; gap: 8px;
  }
  button.control-btn {
    font-size: 12px;
    padding: 6px 10px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 6px;
    margin: 0;
    cursor: pointer;
    transition: all .2s;
    min-width: 50px;
    font-weight: 500;
  }
  button.control-btn:hover:not(:disabled) {
    background: var(--accent);
    transform: translateY(-1px);
  }
  button.control-btn:disabled {
    background: var(--primary);
    color: #fff;
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  button.control-btn:disabled:hover {
    background: var(--primary);
    opacity: 0.5;
  }
  #pauseBtn.paused {
    background: var(--accent);
  }
  #pauseBtn.paused:hover:not(:disabled) {
    background: var(--primary);
  }
  
  /* 플래시 효과 */
  .flash {
    animation: flash 0.4s linear 0s 1;
  }
  @keyframes flash {
    0%   { background: #fff; }
    30%  { background: var(--accent); }
    50%  { background: var(--primary); }
    80%  { background: var(--accent); }
    100% { background: #fff; }
  }
 /*  - 대기 상태 스타일링과 사이클 표시 */
    .waiting-state {
        position: relative;
        animation: waitingPulse 2s infinite;
    }

    @keyframes waitingPulse {
        0%, 100% { 
        background: #fff;
        transform: scale(1);
        }
        50% { 
        background: var(--accent);
        transform: scale(1.02);
        }
    }

    .cycle-info {
        position: absolute;
        top: 50px;
        left: 16px;
        right: 16px;
        font-size: 11px;
        color: var(--text-light);
        line-height: 1.2;
        display: none;
        text-align: center;
        z-index: 1;
        }

    .cycle-info.show {
        display: block;
    }

    .sound-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .sound-toggle label {
        font-size: 11px;
        color: var(--text-light);
    }

    .toggle-switch {
        position: relative;
        width: 40px;
        height: 20px;
        background: #ddd;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle-switch.active {
        background: var(--primary);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transition: left 0.3s;
    }

    .toggle-switch.active::after {
        left: 22px;
    }

  /* 반응형 디자인 */
  @media (max-width: 480px) {
    body {
      padding: 10px;
    }
    .timer-container {
      min-width: 250px;
      padding: 12px;
    }
    #timer {
      font-size: clamp(28px, 8vw, 40px);
      margin: 0px 0 6px 0;
    }
    .btn-group {
      gap: 6px;
      margin-top: 10px;
    }
    button.control-btn {
      font-size: 11px;
      padding: 5px 8px;
      min-width: 45px;
    }
    .cycle-info {
        top: 45px;
        left: 12px;
        right: 12px;
        font-size: 10px;
    }
    .settings-panel {
      min-width: 160px;
      padding: 12px;
    }
    .inputs {
      margin-bottom: 0px;
    }
    
    /* 뽀모도로 입력을 한 줄로 유지 */
    .pomodoro-inputs-wrapper {
      flex-direction: row;
      justify-content: center;
      gap: 3px;
      width: 100%;
      font-size: 11px;
    }
    
    .timer-container {
      padding-top: 20px; /* 상단 여백 추가 */
    }
  }

  @media (max-width: 320px) {
    .timer-container {
      min-width: 220px;
      padding: 10px;
      padding-top: 24px;
    }
    label {
      font-size: 10px;
    }
    input[type="number"] {
      width: 28px;
      height: 16px;
      font-size: 10px;
    }
    .pomodoro-inputs-wrapper {
      flex-direction: row;
      justify-content: center;
      gap: 2px;
      width: 100%;
      font-size: 10px;
    }
  }
</style>
</head>
<body>
<div class="timer-container" id="mainContainer">
    <div class="cycle-info" id="cycleInfo"></div>
  
  <!-- 상단 컨트롤 버튼들 -->
  <div class="top-controls">
    <button class="top-btn" id="settingsBtn" title="설정">⚙️</button>
  </div>
  
  <!-- 설정 패널 -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-section">
      <h4>모드 선택</h4>
      <div class="mode-options">
        <button class="mode-option active" data-mode="0">뽀모도로</button>
        <button class="mode-option" data-mode="1">타이머</button>
        <button class="mode-option" data-mode="2">스톱워치</button>
      </div>
    </div>

    <div class="settings-section">
        <h4>사운드 설정</h4>
        <div class="sound-toggle">
          <label>알림음</label>
          <div class="toggle-switch active" id="soundToggle"></div>
        </div>
      </div>
      
    <div class="settings-section">
      <h4>테마 색상</h4>
      
      <div class="color-section">
        <label>메인 색상</label>
        <div class="color-row">
          <div class="color-option active" data-color="#6b8eef" data-type="primary" style="background: #6b8eef;"></div>
          <div class="color-option" data-color="#ff6b6b" data-type="primary" style="background: #ff6b6b;"></div>
          <div class="color-option" data-color="#4ecdc4" data-type="primary" style="background: #4ecdc4;"></div>
          <div class="color-option" data-color="#96ceb4" data-type="primary" style="background: #96ceb4;"></div>
          <div class="color-option" data-color="#9b59b6" data-type="primary" style="background: #9b59b6;"></div>
          <div class="color-option" data-color="#f39c12" data-type="primary" style="background: #f39c12;"></div>
          <input type="color" class="color-picker" id="primaryPicker" value="#6b8eef">
        </div>
      </div>
      
      <div class="color-section">
        <label>강조 색상</label>
        <div class="color-row">
          <div class="color-option active" data-color="#f99ca9" data-type="accent" style="background: #f99ca9;"></div>
          <div class="color-option" data-color="#4ecdc4" data-type="accent" style="background: #4ecdc4;"></div>
          <div class="color-option" data-color="#45b7d1" data-type="accent" style="background: #45b7d1;"></div>
          <div class="color-option" data-color="#feca57" data-type="accent" style="background: #feca57;"></div>
          <div class="color-option" data-color="#e74c3c" data-type="accent" style="background: #e74c3c;"></div>
          <div class="color-option" data-color="#95a5a6" data-type="accent" style="background: #95a5a6;"></div>
          <input type="color" class="color-picker" id="accentPicker" value="#f99ca9">
        </div>
      </div>
    </div>
  </div>

  <div class="inputs" id="inputSection">
    <div id="pomodoroInputs">
      <div class="pomodoro-inputs-wrapper">
        <input type="number" id="workInput" value="25" min="1" max="180">분 / 
        <input type="number" id="breakInput" value="5" min="1" max="60">분 / 
        <input type="number" id="cyclesInput" value="4" min="1" max="20">회
      </div>
    </div>
    <div id="timerInputs" class="hidden">
      <div style="display: flex; justify-content: center; align-items: center;">
        <label>
          <input type="number" id="timerMinutes" value="10" min="1" max="999">분
        </label>
      </div>
    </div>
  </div>

  <div id="timer">25:00</div>

  <div class="btn-group">
    <button class="control-btn" id="startBtn">START</button>
    <button class="control-btn" id="pauseBtn" disabled>PAUSE</button>
    <button class="control-btn" id="stopBtn" disabled>RESET</button>
  </div>

</div>
<audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
<script>
  let workMinutes, breakMinutes, cycles;
  let currentCycle = 0;
  let isWork = true;
  let timer, totalSeconds, running = false, paused = false;
  
// 모드 관리
  let currentMode = 0; // 0: 뽀모도로, 1: 타이머, 2: 스톱워치
  let soundEnabled = true;
  let waitingForUser = false;   

  const statusEl = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const alarmSound = document.getElementById('alarmSound');
  const mainContainer = document.getElementById('mainContainer');

  const workInput = document.getElementById('workInput');
  const breakInput = document.getElementById('breakInput');
  const cyclesInput = document.getElementById('cyclesInput');
  const inputSection = document.getElementById('inputSection');

  // 설정 관련
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const primaryPicker = document.getElementById('primaryPicker');
  const accentPicker = document.getElementById('accentPicker');
  const modeOptions = document.querySelectorAll('.mode-option');

  // 초기 테마 설정
  function updateTheme(primary, accent) {
    document.documentElement.style.setProperty('--primary', primary);
    document.documentElement.style.setProperty('--accent', accent);
  }

// 각 모드별 상태 저장
  let modeStates = {
    0: { running: false, paused: false, timer: null, totalSeconds: 0, currentCycle: 0, isWork: true }, // 뽀모도로
    1: { running: false, paused: false, timer: null, totalSeconds: 0 }, // 타이머
    2: { running: false, paused: false, timer: null, totalSeconds: 0 }  // 스톱워치
  };

  // 설정 저장
  function saveSettings() {
    const settings = {
      currentMode,
      soundEnabled,
      primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary'),
      accentColor: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
      workMinutes: workInput.value,
      breakMinutes: breakInput.value,
      cycles: cyclesInput.value,
      timerMinutes: document.getElementById('timerMinutes').value
    };
    localStorage.setItem('timerSettings', JSON.stringify(settings));
  }

  // 설정 불러오기
  function loadSettings() {
    const saved = localStorage.getItem('timerSettings');
    if (saved) {
      const settings = JSON.parse(saved);
      currentMode = settings.currentMode || 0;
      soundEnabled = settings.soundEnabled !== false;
      
      if (settings.primaryColor) {
        document.documentElement.style.setProperty('--primary', settings.primaryColor);
        primaryPicker.value = settings.primaryColor;
      }
      if (settings.accentColor) {
        document.documentElement.style.setProperty('--accent', settings.accentColor);
        accentPicker.value = settings.accentColor;
      }
      
      workInput.value = settings.workMinutes || 25;
      breakInput.value = settings.breakMinutes || 5;
      cyclesInput.value = settings.cycles || 4;
      document.getElementById('timerMinutes').value = settings.timerMinutes || 10;
      
      // UI 업데이트
      modeOptions.forEach((opt, index) => {
        opt.classList.toggle('active', index === currentMode);
      });
      
      document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
    }
  }

  // 모드 변경
  modeOptions.forEach(option => {
    option.addEventListener('click', () => {
      // 현재 모드 상태 저장
      saveCurrentModeState();
      
      modeOptions.forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      currentMode = parseInt(option.dataset.mode);
      
      // 새 모드 상태 복원
      restoreModeState();
      updateMode();
    });
  });

  // 현재 모드 상태 저장
  function saveCurrentModeState() {
    // 현재 표시된 상태는 저장하지 않고, 각 모드별 독립 상태만 유지
  }

  // 모드 상태 복원
  function restoreModeState() {
    const state = modeStates[currentMode];
    
    // UI 상태 업데이트
    updateButtonStates(state);
    if (state.running) {
      updateTimerDisplay(state);
    }
  }

  // 버튼 상태 업데이트
  function updateButtonStates(state) {
    startBtn.disabled = state.running;
    pauseBtn.disabled = !state.running;
    stopBtn.disabled = !state.running;
    
    if (state.running && state.paused) {
      pauseBtn.textContent = 'RESUME';
      pauseBtn.classList.add('paused');
    } else {
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
  }

  // 타이머 표시 업데이트
  function updateTimerDisplay(state) {
    const minutes = Math.floor(state.totalSeconds / 60);
    const seconds = state.totalSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  function updateMode() {
    const pomodoroInputs = document.getElementById('pomodoroInputs');
    const timerInputs = document.getElementById('timerInputs');
    const cycleInfo = document.getElementById('cycleInfo');
    
    // 모든 입력 섹션 숨기기
    pomodoroInputs.classList.add('hidden');
    timerInputs.classList.add('hidden');
    cycleInfo.classList.remove('show'); // 사이클 정보 숨기기
    
    switch(currentMode) {
      case 0: // 뽀모도로
        pomodoroInputs.classList.remove('hidden');
        cycleInfo.classList.add('show'); // 뽀모도로에서만 사이클 정보 표시
        const state0 = modeStates[0];
        if (!state0.running) {
          timerEl.textContent = `${workInput.value.toString().padStart(2,'0')}:00`;
          cycleInfo.textContent = ''; // 초기 상태에서는 빈 텍스트
        } else {
          updateTimerDisplay(state0);
        }
        break;
      case 1: // 타이머
        timerInputs.classList.remove('hidden');
        const state1 = modeStates[1];
        if (!state1.running) {
          const timerMinutes = parseInt(document.getElementById('timerMinutes').value, 10) || 10;
          timerEl.textContent = `${timerMinutes.toString().padStart(2,'0')}:00`;
        } else {
          updateTimerDisplay(state1);
        }
        break;
      case 2: // 스톱워치
        // 스톱워치는 입력 영역이 없으므로 빈 공간으로 동일한 높이 유지
        inputSection.style.minHeight = '44px';
        const state2 = modeStates[2];
        if (!state2.running) {
          timerEl.textContent = '00:00';
        } else {
          updateTimerDisplay(state2);
        }
        break;
    }
  }

  // 설정 패널 토글
  settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    settingsPanel.classList.toggle('active');
  });

  // 패널 외부 클릭시 닫기
  document.addEventListener('click', (e) => {
    if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
      settingsPanel.classList.remove('active');
    }
  });

  // 색상 옵션 선택
  const colorOptions = document.querySelectorAll('.color-option');
  colorOptions.forEach(option => {
    option.addEventListener('click', () => {
      const color = option.dataset.color;
      const type = option.dataset.type;
      
      document.querySelectorAll(`[data-type="${type}"]`).forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      document.documentElement.style.setProperty(`--${type}`, color);
      
      if (type === 'primary') {
        primaryPicker.value = color;
      } else {
        accentPicker.value = color;
      }
      
      saveSettings();
    });
  });

  // 커스텀 색상 선택
  primaryPicker.addEventListener('change', (e) => {
    const color = e.target.value;
    document.documentElement.style.setProperty('--primary', color);
    document.querySelectorAll('[data-type="primary"]').forEach(opt => opt.classList.remove('active'));
    saveSettings();
  });

  accentPicker.addEventListener('change', (e) => {
    const color = e.target.value;
    document.documentElement.style.setProperty('--accent', color);
    document.querySelectorAll('[data-type="accent"]').forEach(opt => opt.classList.remove('active'));
    saveSettings();
  });

  function updateTimer() {
    const state = modeStates[currentMode];
    const minutes = Math.floor(state.totalSeconds / 60);
    const seconds = state.totalSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  function flashScreen(times=3) {
    let count = 0;
    const flashFn = () => {
      mainContainer.classList.add('flash');
      setTimeout(()=> mainContainer.classList.remove('flash'), 290);
      if (++count < times) setTimeout(flashFn, 400);
    };
    flashFn();
  }

  function startPomodoro() {
    const state = modeStates[0];
    
    if (state.currentCycle >= state.cycles) {
      if (currentMode === 0) {
        timerEl.textContent = '🎉 끝! 🎉';
        document.getElementById('cycleInfo').textContent = `모든 사이클 완료!`;
      }
      state.running = false;
      if (currentMode === 0) {
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }
      return;
    }
    
    // 대기 상태라면 다음 단계로 진행하지 않음
    if (waitingForUser) return;
    
    if (state.isWork) {
      state.totalSeconds = state.workMinutes * 60;
      if (currentMode === 0) {
        document.getElementById('cycleInfo').textContent = 
          `${state.currentCycle + 1}/${state.cycles} 사이클 - 집중시간`;
      }
    } else {
      state.totalSeconds = state.breakMinutes * 60;
      if (currentMode === 0) {
        document.getElementById('cycleInfo').textContent = 
          `${state.currentCycle + 1}/${state.cycles} 사이클 - 휴식시간`;
      }
    }
    
    if (currentMode === 0) updateTimer();
    
    state.running = true;
    state.paused = false;
    
    if (currentMode === 0) {
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
    
    state.timer = setInterval(() => {
      if (!state.paused) {
        state.totalSeconds--;
        if (currentMode === 0) updateTimer();
        
        if (state.totalSeconds <= 0) {
          clearInterval(state.timer);
          
          // 알림 재생
          if (soundEnabled) {
            alarmSound.currentTime = 0;
            alarmSound.play();
          }
          
          // 대기 상태로 전환
          waitingForUser = true;
          if (currentMode === 0) {
            mainContainer.classList.add('waiting-state');
            timerEl.textContent = '계속하기';
            document.getElementById('cycleInfo').textContent = 
              `${state.currentCycle + 1}/${state.cycles} 사이클 - ${state.isWork ? '집중' : '휴식'} 완료!`;
          }
          
          // 상태 업데이트 준비 (실제 전환은 사용자 클릭 후)
          if (!state.isWork) state.currentCycle++;
          state.isWork = !state.isWork;
          
          state.running = false;
          if (currentMode === 0) {
            startBtn.disabled = true;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
          }
        }
      }
    }, 1000);
  }

  function startRegularTimer() {
    const state = modeStates[1];
    const minutes = parseInt(document.getElementById('timerMinutes').value, 10);
    
    if (isNaN(minutes) || minutes <= 0) {
      alert('올바른 시간을 입력해주세요.');
      if (currentMode === 1) {
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }
      return;
    }
    
    state.totalSeconds = minutes * 60;
    state.timerMinutes = minutes;
    
    if (currentMode === 1) updateTimer();
    
    state.running = true;
    state.paused = false;
    
    if (currentMode === 1) {
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
    
    state.timer = setInterval(() => {
      if (!state.paused) {
        state.totalSeconds--;
        if (currentMode === 1) updateTimer();
        
        if (state.totalSeconds <= 0) {
          clearInterval(state.timer);
          alarmSound.currentTime = 0;
          alarmSound.play();
          if (currentMode === 1) {
            flashScreen(3);
            timerEl.textContent = '⏰ 완료!';
          }
          
          state.running = false;
          if (currentMode === 1) {
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
          }
        }
      }
    }, 1000);
  }

  function startStopwatch() {
    const state = modeStates[2];
    
    state.totalSeconds = 0;
    if (currentMode === 2) updateTimer();
    
    state.running = true;
    state.paused = false;
    
    if (currentMode === 2) {
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
    
    state.timer = setInterval(() => {
      if (!state.paused) {
        state.totalSeconds++;
        if (currentMode === 2) updateTimer();
      }
    }, 1000);
  }

  function stopTimer() {
    // 대기 상태 초기화
    waitingForUser = false;
    mainContainer.classList.remove('waiting-state');
    
    const state = modeStates[currentMode];
    
    clearInterval(state.timer);
    
    // 현재 모드 상태 초기화
    state.running = false;
    state.paused = false;
    state.timer = null;
    state.totalSeconds = 0;
    
    alarmSound.pause();
    alarmSound.currentTime = 0;
    
    if (currentMode === 0) { // 뽀모도로
      state.currentCycle = 0;
      state.isWork = true;
      timerEl.textContent = `${workInput.value.toString().padStart(2,'0')}:00`;
      document.getElementById('cycleInfo').textContent = ''; // 사이클 정보 초기화
    } else if (currentMode === 1) { // 타이머
      const timerMinutes = parseInt(document.getElementById('timerMinutes').value, 10) || 10;
      timerEl.textContent = `${timerMinutes.toString().padStart(2,'0')}:00`;
    } else if (currentMode === 2) { // 스톱워치
      timerEl.textContent = '00:00';
    }
    
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    pauseBtn.textContent = 'PAUSE';
    pauseBtn.classList.remove('paused');
    stopBtn.disabled = true;
  }

  function pauseTimer() {
    const state = modeStates[currentMode];
    
    if (state.running && !state.paused) {
      state.paused = true;
      pauseBtn.textContent = 'RESUME';
      pauseBtn.classList.add('paused');
    } else if (state.running && state.paused) {
      state.paused = false;
      pauseBtn.textContent = 'PAUSE';
      pauseBtn.classList.remove('paused');
    }
  }

  startBtn.addEventListener('click', () => {
    const state = modeStates[currentMode];
    
    // 현재 모드 상태 업데이트
    state.running = true;
    state.paused = false;
    
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    stopBtn.disabled = false;
    
    switch(currentMode) {
      case 0: // 뽀모도로
        const workMin = parseInt(workInput.value, 10);
        const breakMin = parseInt(breakInput.value, 10);
        const cycleCount = parseInt(cyclesInput.value, 10);
        
        if (isNaN(workMin) || workMin <= 0 || isNaN(breakMin) || breakMin <= 0 || isNaN(cycleCount) || cycleCount <= 0) {
          alert('모든 입력값은 양의 정수여야 합니다.');
          state.running = false;
          startBtn.disabled = false;
          pauseBtn.disabled = true;
          stopBtn.disabled = true;
          return;
        }
        
        state.workMinutes = workMin;
        state.breakMinutes = breakMin;
        state.cycles = cycleCount;
        state.currentCycle = 0;
        state.isWork = true;
        startPomodoro();
        break;
      case 1: // 타이머
        startRegularTimer();
        break;
      case 2: // 스톱워치
        startStopwatch();
        break;
    }
  });

  stopBtn.addEventListener('click', stopTimer);
  pauseBtn.addEventListener('click', pauseTimer);

  // 대기 상태에서 클릭하면 다음 타이머 시작
  mainContainer.addEventListener('click', () => {
    if (waitingForUser && currentMode === 0) {
      waitingForUser = false;
      mainContainer.classList.remove('waiting-state');
      startPomodoro();
    }
  });

  // 사운드 토글
  document.addEventListener('DOMContentLoaded', () => {
    const soundToggle = document.getElementById('soundToggle');
    if (soundToggle) {
      soundToggle.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        soundToggle.classList.toggle('active', soundEnabled);
        saveSettings();
      });
    }
  });

  // 설정 저장 이벤트들
  [workInput, breakInput, cyclesInput].forEach(input => {
    input.addEventListener('change', saveSettings);
  });
  document.getElementById('timerMinutes').addEventListener('change', saveSettings);

  // 페이지 로드 시 설정 불러오기
  window.addEventListener('load', () => {
    loadSettings();
    updateMode();
  });

  // 초기 모드 설정
  updateMode();

</script>
</body>
</html>
